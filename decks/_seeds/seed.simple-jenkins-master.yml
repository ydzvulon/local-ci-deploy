# https://taskfile.dev

version: '3'
env:
  _vcomment: '#'

vars:
  GREETING: Hello, World!
  _dcomment_: "$(echo '$_vcomment')"

  VAL_DC_UI_JENKINS_PORT_EXT: 28082
  _show_url_exp: |-
    ui-jenkins-url: http://localhost:{{.VAL_DC_UI_JENKINS_PORT_EXT}}

tasks:
  spin-up-flow:
    desc: restart componets
    cmds:
      - task: spin-down
        vars:
          safe_run: 'true'
      - task: spin-up-flow.prepare
      - task: spin-up
      - task: show-urls

  spin-up-flow.prepare:
    desc: _
    deps:
      - task: generate/docker-compose.yml
    cmds: 
      - echo "{{.TASK}} done deps"

  spin-up:
    desc: _
    cmds: 
      - docker-compose -f {{.docker_compose_yaml}} up  -d
  
  spin-down:
    desc: _
    vars:
      rest_suff: '{{if .safe_run}}| true{{else}} {{end}}'
    cmds: 
      - docker-compose -f {{.docker_compose_yaml}} down {{.rest_suff}}

  write-to-file:
    desc: _
    args:
      file: ''
      content: ''
      src_file: sourcefile
    vars:
      show_written: '{{default "" .show_written}}'
    sources:
      - '{{.src_file}}'
    generates:
      - '{{.file}}'
    cmds:
      - |-
        cat <<EOF > {{.file}}
        {{.content}}
        EOF
        if [[ "{{.show_written}}" != "" ]]; then
          cat {{.file}}
        fi

  generate/docker-compose.yml:
    desc: generates dockerfile from parts
    cmds:
      - task: write-to-file
        vars:
          src_file: Taskfile.yml
          file: '{{.docker_compose_yaml}}'
          content: '{{.__gens_docker_compose_cont}}'
    vars:
      __gens_docker_compose_cont: |-
        version: "3.9"
        services:
          jencondait.samexample.com:
            hostname: 'jencondait.samexample.com'
            image: yairdar/jenconda:v0.8.2rc-2021.09.27rc
            ports:
              - "{{.VAL_DC_UI_JENKINS_PORT_EXT}}:8080"
            volumes:
              - "/var/run/docker.sock:/var/run/docker.sock"
              - "../..:/repo"
            networks:
              simplejen:
        networks:
          simplejen:
            driver: bridge


